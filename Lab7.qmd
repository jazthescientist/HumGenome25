---
title: "Lab 7"
author: "Jazlynn Bailey"
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
execute: 
  warning: false
  message: false
---

# 

#### Load Libraries + Initial code

```{r}
library(tidyverse)
library(lubridate)

# set a writable path (your home directory)
file_path <- "~/time_series_covid19_confirmed_global.csv"

# download file
download.file(
  url = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",
  destfile = file_path,
  mode = "wb"
)

# read and rename columns
time_series_confirmed <- read_csv(file_path) |>
  rename(
    Province_State = `Province/State`,
    Country_Region = `Country/Region`
  )


# file already downloaded here:
file_path <- "~/time_series_covid19_confirmed_global.csv"

# try saving a copy into the lab folder (only if permitted)
target_path <- "/work/pi_jlb_umass_edu/blanchardlab/RNA_phages/time_series_covid19_confirmed_global.csv"

# check if you can write to the folder
can_write <- file.access(dirname(target_path), 2) == 0

if (can_write) {
  file.copy(from = file_path, to = target_path, overwrite = TRUE)
  message("Saved to RNA_phages folder.")
} else {
  message("No permission to save to RNA_phages. Keeping it in home directory.")
}

# load from whichever path exists
if (file.exists(target_path)) {
  covid_path <- target_path
} else {
  covid_path <- file_path
}

time_series_confirmed <- read_csv(covid_path) |>
  rename(
    Province_State = `Province/State`,
    Country_Region = `Country/Region`
  )



colnames(time_series_confirmed)[1:10]   # first columns
tail(colnames(time_series_confirmed))   # last columns (should be dates)



time_series_confirmed_long <- time_series_confirmed |>
  pivot_longer(
    cols = -(Province_State:Long),    # all date columns
    names_to = "Date",
    values_to = "Confirmed"
  )



time_series_confirmed_long <- time_series_confirmed_long |>
  mutate(Date = mdy(Date))

time_series_confirmed_long |>
  group_by(Country_Region, Date) |>
  summarise(Confirmed = sum(Confirmed), .groups = "drop") |>
  filter(Country_Region == "US") |>
  ggplot(aes(x = Date, y = Confirmed)) +
  geom_line() +
  geom_point() +
  ggtitle("US COVID-19 Confirmed Cases Over Time")

```



#### In lab code 
```{r}

time_series_confirmed_long |> 
    group_by(Country_Region, Date) |> 
    summarise(Confirmed = sum(Confirmed)) |> 
    filter (Country_Region %in% c("China","France","Italy", 
                                "Korea, South", "US")) |> 
    ggplot(aes(x = Date,  y = Confirmed, color = Country_Region)) + 
      geom_point() +
      geom_line() +
      ggtitle("COVID-19 Confirmed Cases")

```






#### In lab code 
```{r}
time_series_confirmed_long_daily <-time_series_confirmed_long |> 
    group_by(Country_Region, Date) |> 
    summarise(Confirmed = sum(Confirmed)) |> 
    mutate(Daily = Confirmed - lag(Confirmed, default = first(Confirmed )))

time_series_confirmed_long_daily |> 
    filter (Country_Region == "US") |> 
    ggplot(aes(x = Date,  y = Daily, color = Country_Region)) + 
      geom_point() +
      ggtitle("COVID-19 Confirmed Cases")


```


#### In lab code 
```{r}

time_series_confirmed_long_daily |> 
    filter (Country_Region == "US") |> 
    ggplot(aes(x = Date,  y = Daily, color = Country_Region)) + 
      geom_line() +
      ggtitle("COVID-19 Confirmed Cases")

```

#### In lab code 
```{r}

time_series_confirmed_long_daily |> 
    filter (Country_Region == "US") |> 
    ggplot(aes(x = Date,  y = Daily, color = Country_Region)) + 
      geom_smooth() +
      ggtitle("COVID-19 Confirmed Cases")

```



#### In lab code 
```{r}

time_series_confirmed_long_daily |> 
    filter (Country_Region == "US") |> 
    ggplot(aes(x = Date,  y = Daily, color = Country_Region)) + 
      geom_smooth(method = "gam", se = FALSE) +
      ggtitle("COVID-19 Confirmed Cases")

```







#### In lab code 
```{r}

library(gganimate)
library(gifski)
theme_set(theme_bw())


daily_counts <- time_series_confirmed_long_daily |> 
      filter (Country_Region == "US")

p <- ggplot(daily_counts, aes(x = Date,  y = Daily, color = Country_Region)) + 
        geom_point() +
        ggtitle("Confirmed COVID-19 Cases") +
# gganimate lines  
        geom_point(aes(group = seq_along(Date))) +
        transition_reveal(Date) 

# make the animation
 animate(p, renderer = gifski_renderer(), end_pause = 15)
 
 anim_save("daily_counts_US.gif", p)
```
#### Example code 5.1-5.2
```{r}


# Compute rate per 10,000
table1 |>
  mutate(rate = cases / population * 10000)
#> # A tibble: 6 × 5
#>   country      year  cases population  rate
#>   <chr>       <dbl>  <dbl>      <dbl> <dbl>
#> 1 Afghanistan  1999    745   19987071 0.373
#> 2 Afghanistan  2000   2666   20595360 1.29 
#> 3 Brazil       1999  37737  172006362 2.19 
#> 4 Brazil       2000  80488  174504898 4.61 
#> 5 China        1999 212258 1272915272 1.67 
#> 6 China        2000 213766 1280428583 1.67

# Compute total cases per year
table1 |> 
  group_by(year) |> 
  summarize(total_cases = sum(cases))
#> # A tibble: 2 × 2
#>    year total_cases
#>   <dbl>       <dbl>
#> 1  1999      250740
#> 2  2000      296920

# Visualize changes over time
ggplot(table1, aes(x = year, y = cases)) +
  geom_line(aes(group = country), color = "grey50") +
  geom_point(aes(color = country, shape = country)) +
  scale_x_continuous(breaks = c(1999, 2000)) # x-axis breaks at 1999 and 2000





```


## Exercises 5.2.1

### 1.
Each row shows a country in a specific year, and each column shows its TB cases, population, and calculated rate.

### 2.

```{r}

table2_rate <- table2 |>
  pivot_wider(names_from = type, values_from = count) |>
  mutate(rate = cases / population * 10000)

table3_rate <- table3 |>
  separate(rate, into = c("cases", "population"), sep = "/") |>
  mutate(cases = as.numeric(cases),
         population = as.numeric(population),
         rate = cases / population * 10000)

ggplot(table1, aes(x = year, y = cases)) +
  geom_line(aes(group = country), color = "grey60") +
  geom_point(aes(color = country)) +
  facet_wrap(~ country, scales = "free_y")


```

### 3.

```{r}
countries <- c("US", "India", "Brazil", "China", "Italy")

daily_cases <- time_series_confirmed_long |>
  group_by(Country_Region, Date) |>
  summarise(Confirmed = sum(Confirmed), .groups = "drop") |>
  group_by(Country_Region) |>
  arrange(Date) |>
  mutate(Daily = Confirmed - lag(Confirmed)) |>
  filter(Country_Region %in% countries)

ggplot(daily_cases, aes(x = Date, y = Daily, color = Country_Region)) +
  geom_line() +
  labs(title = "Daily COVID-19 Confirmed Cases",
       x = "Date", y = "Daily Cases")

```

### 4.



```{r, eval=FALSE}
# download deaths data to your home directory
death_file <- "~/time_series_covid19_deaths_global.csv"

if (!file.exists(death_file)) {
  download.file(
    url = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",
    destfile = death_file,
    mode = "wb"
  )
}

# read and reshape dataset
deaths <- read_csv(death_file)

deaths_long <- deaths |>
  pivot_longer(
    cols = -c(`Province/State`, `Country/Region`, Lat, Long),
    names_to = "Date",
    values_to = "Deaths"
  ) |>
  mutate(Date = mdy(Date))

# save reshaped data for faster reuse
saveRDS(deaths_long, "deaths_long.rds")
```


```{r}
deaths_long <- readRDS("deaths_long.rds")

north_america <- deaths_long |>
  filter(`Country/Region` %in% c("US", "Canada", "Mexico")) |>
  group_by(`Country/Region`, Date) |>
  summarise(Deaths = sum(Deaths), .groups = "drop")

ggplot(north_america, aes(x = Date, y = Deaths, color = `Country/Region`)) +
  geom_line() +
  labs(
    title = "Cumulative COVID-19 Deaths: US, Canada, Mexico",
    x = "Date",
    y = "Deaths"
  )
```


### 6.



```{r, eval=FALSE}
```{r, eval=FALSE}
# pick countries
countries <- c("US", "Canada", "Mexico", "India", "Brazil")

daily_deaths <- deaths_long |>
  group_by(`Country/Region`, Date) |>
  summarise(Deaths = sum(Deaths), .groups = "drop") |>
  group_by(`Country/Region`) |>
  arrange(Date) |>
  mutate(Daily_Deaths = Deaths - lag(Deaths)) |>
  filter(`Country/Region` %in% countries)

p <- ggplot(daily_deaths, aes(x = Date, y = Daily_Deaths, color = `Country/Region`)) +
  geom_line() +
  labs(
    title = "Daily COVID-19 Deaths | {frame_time}",
    x = "Date",
    y = "Daily Deaths"
  ) +
  transition_time(Date) +
  ease_aes("linear")

# save animation as GIF
anim_save("daily_deaths.gif", animate(p, fps = 20, width = 800, height = 500))
```

```{r}

knitr::include_graphics("daily_deaths.gif")
```

```


